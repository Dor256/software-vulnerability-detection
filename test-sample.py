import pickle
from sys import argv
import requests
import pandas as pd
from glob import glob

if len(argv) < 2:
   print("Missing argument - javascript file name")
   print("Usage:\n\ttest-sample.py some-javascript-file.js")
   exit(0)

filePath = argv[1]
print("Reading the contents of: " + filePath)
func = open(filePath, "r").read()
print("Sending file content for analysis on server")
res = requests.post('http://localhost:3000', data=func, headers={'Content-Type': 'text/plain'}).json()
df = pd.DataFrame([res], columns=res.keys())
print("Successfully analysed static javascript code")

print("Loading ML model from file")
model = pickle.load(open('./models/decision_tree_over_sampling', 'rb'))

result = model.predict(df)
probability_result = model.predict_proba(df)
vuln_prob = probability_result[:,1][0]
print("Javascript file is VULNERABLE with a probability of {:.2%}".format(vuln_prob)) if vuln_prob >= 0.5 else print("Javascript file is NOT vulnerable with a probability of {:.2%}".format(1 - vuln_prob))