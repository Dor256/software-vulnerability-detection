import pickle
from sys import argv
import requests
import pandas as pd
import numpy as np
from glob import glob

if len(argv) < 2:
   raise ValueError("Missing argument: File name")

filePath = argv[1]
print("Reading the contents of: " + filePath)
func = open(filePath, "r").read()
print("Sending file content for analysis on server")
print(func[0:5])
res = requests.post('http://localhost:3000', data=func, headers={'Content-Type': 'text/plain'}).json()
df = pd.DataFrame([res], columns=res.keys())
print("Successfully analysed static javascript code")

print("Loading ML model from file")
for file in glob('./models/logistic_regression_no_sampling'):
   print(file)
   model = pickle.load(open(file, 'rb'))

   result = model.predict(df)
   probability_result = model.predict_proba(df)
   vuln_prob = probability_result[:,1][0]
   print("result " + str(result[0]))
   print("prob " + str(vuln_prob))
   print("Javascript file is VULNERABLE with a probability of {:.2%}".format(vuln_prob)) if vuln_prob >= 0.5 else print("Javascript file is NOT vulnerable with a probability of {:.2%}".format(1 - vuln_prob))